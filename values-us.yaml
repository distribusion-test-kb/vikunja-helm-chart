# Helm Chart Values for US cluster
# Below are the values to pass to the Vikunja Helm chart


postgresql:
  enabled: false

redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: false
  image:
    registry: docker.io
    repository: redis
    tag: '8.2'

typesense:
  enabled: false

vikunja:

  controller:
    replicas: 2

  image:
    repository: vikunja/vikunja
    pullPolicy: IfNotPresent

  # Service configuration with NEG for GCP Load Balancer
  service:
    main:
      type: ClusterIP
      ports:
        http:
          port: 3456
      annotations:
        cloud.google.com/neg: '{"exposed_ports": {"3456":{"name": "vikunja-neg-us"}}}'
        cloud.google.com/backend-config: '{"default": "vikunja-backend-config"}'

  # Disable ingress - using GCP Load Balancer with NEG instead
  ingress:
    main:
      enabled: false

  # Service account for GCS access
  serviceAccount:
    create: false
    name: vikunja-sa

  # Vikunja configuration via ConfigMap
  # Disabled - using custom template in templates/configmap-override.yaml to inject secrets
  configMaps:
    api-config:
      enabled: false

  # Environment variables for sensitive data from secrets
  env:
    VIKUNJA_DATABASE_USER:
      valueFrom:
        secretKeyRef:
          name: vikunja-secrets
          key: db-username
    VIKUNJA_DATABASE_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: vikunja-secrets
          key: db-password
    VIKUNJA_SERVICE_JWTSECRET:
      valueFrom:
        secretKeyRef:
          name: vikunja-secrets
          key: jwt-secret
    VIKUNJA_AUTH_OPENID_PROVIDERS_0_CLIENTSECRET:
      valueFrom:
        secretKeyRef:
          name: vikunja-secrets
          key: openid-client-secret

  # Persistence - GCS bucket mounted via CSI driver
  persistence:
    data:
      enabled: true
      type: pvc
      existingClaim: vikunja-gcs-pvc
      mountPath: /app/vikunja/files

  # Resource limits
  resources:
    limits:
      cpu: 1000m
      memory: 1024Mi
    requests:
      cpu: 250m
      memory: 512Mi

  # Probes
  probes:
    liveness:
      enabled: true
      custom: true
      spec:
        httpGet:
          path: /api/v1/info
          port: http
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 5
        failureThreshold: 3
    readiness:
      enabled: true
      custom: true
      spec:
        httpGet:
          path: /api/v1/info
          port: http
        initialDelaySeconds: 10
        periodSeconds: 5
        timeoutSeconds: 3
        failureThreshold: 3
    startup:
      enabled: false

  # Pod annotations for GCS CSI driver sidecar
  podAnnotations:
    gke-gcsfuse/volumes: "true"
    gke-gcsfuse/cpu-limit: "250m"
    gke-gcsfuse/memory-limit: "256Mi"
    gke-gcsfuse/ephemeral-storage-limit: "1Gi"

  # Security context
  podSecurityContext:
    fsGroup: 1000
    runAsNonRoot: true
    runAsUser: 1000

  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false

  # Affinity rules for multi-region deployment
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - vikunja
            topologyKey: kubernetes.io/hostname

# NOTE: Service accounts, secrets, PV/PVC, and BackendConfig are deployed separately
# using values-pre-install-us.yaml to ensure External Secrets syncs before main deployment
